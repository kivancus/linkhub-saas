<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkHub SaaS - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div x-data="linkHubApp()" class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">ðŸš€ LinkHub SaaS</h1>
                    <p class="text-gray-600">Manage your Link-in-Bio page</p>
                </div>
                <div x-show="user" class="text-right">
                    <p class="text-sm text-gray-600">Welcome, <span x-text="user?.email"></span></p>
                    <button @click="logout()" class="text-red-600 hover:text-red-800 text-sm">Logout</button>
                </div>
            </div>
        </div>

        <!-- Auth Section -->
        <div x-show="!user" class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Login -->
                <div>
                    <h2 class="text-xl font-semibold mb-4">Login</h2>
                    <form @submit.prevent="login()">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input x-model="loginForm.email" type="email" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input x-model="loginForm.password" type="password" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                            Login
                        </button>
                    </form>
                </div>

                <!-- Register -->
                <div>
                    <h2 class="text-xl font-semibold mb-4">Register</h2>
                    <form @submit.prevent="register()">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input x-model="registerForm.email" type="email" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input x-model="registerForm.password" type="password" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                            <input x-model="registerForm.username" type="text" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
                            Register
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div x-show="user">
            <!-- Username Claiming -->
            <div x-show="user && !user.username" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-yellow-800 mb-2">Claim Your Username</h3>
                <form @submit.prevent="claimUsername()" class="flex gap-2">
                    <input x-model="usernameForm.username" type="text" placeholder="Enter username" required
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        Claim Username
                    </button>
                </form>
            </div>

            <!-- Public Page Link -->
            <div x-show="user?.username" class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-green-800 mb-2">Your Public Page</h3>
                <p class="text-green-700">
                    Your bio page is live at: 
                    <a :href="`http://localhost:3000/${user.username}`" target="_blank" 
                       class="font-medium underline hover:text-green-900" x-text="`http://localhost:3000/${user.username}`"></a>
                </p>
            </div>

            <!-- Bio Page Management -->
            <div class="grid lg:grid-cols-2 gap-6 mb-6">
                <!-- Theme Selection -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-4">Theme Selection</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <template x-for="theme in themes" :key="theme.id">
                            <div class="border rounded-lg p-3 cursor-pointer hover:bg-gray-50"
                                 :class="bioPage?.themeId === theme.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200'"
                                 @click="updateTheme(theme.id)">
                                <div class="flex items-center justify-between">
                                    <span class="font-medium" x-text="theme.name"></span>
                                    <span x-show="theme.isPremium" class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">PRO</span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Subscription -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold mb-4">Subscription</h3>
                    <div x-show="subscription">
                        <p class="text-sm text-gray-600 mb-2">Current Plan:</p>
                        <p class="font-semibold text-lg" x-text="subscription?.plan?.name"></p>
                        <p class="text-sm text-gray-500 mb-4" x-text="`$${subscription?.plan?.price}/month`"></p>
                        
                        <div x-show="subscription?.plan?.id === 'free'" class="space-y-2">
                            <template x-for="plan in subscriptionPlans.filter(p => p.id !== 'free')" :key="plan.id">
                                <button @click="upgradeToPlan(plan)" 
                                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 text-sm">
                                    Upgrade to <span x-text="plan.name"></span> - $<span x-text="plan.price"></span>/<span x-text="plan.interval"></span>
                                </button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Links Management -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Manage Links</h3>
                    <span class="text-sm text-gray-500" x-text="`${bioPage?.links?.length || 0}/5 links (Free plan)`"></span>
                </div>

                <!-- Add Link Form -->
                <form @submit.prevent="addLink()" class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                            <input x-model="linkForm.title" type="text" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">URL</label>
                            <input x-model="linkForm.url" type="url" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex items-end">
                            <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
                                Add Link
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Links List -->
                <div class="space-y-3">
                    <template x-for="link in bioPage?.links || []" :key="link.id">
                        <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                            <div class="flex-1">
                                <h4 class="font-medium" x-text="link.title"></h4>
                                <p class="text-sm text-gray-600" x-text="link.url"></p>
                            </div>
                            <button @click="deleteLink(link.id)" 
                                    class="text-red-600 hover:text-red-800 px-3 py-1 text-sm">
                                Delete
                            </button>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Analytics -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold mb-4">Analytics</h3>
                <div x-show="analytics" class="grid md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-blue-600" x-text="analytics?.last30Days?.totalViews || 0"></p>
                        <p class="text-sm text-gray-600">Page Views (30 days)</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-green-600" x-text="analytics?.last30Days?.totalClicks || 0"></p>
                        <p class="text-sm text-gray-600">Link Clicks (30 days)</p>
                    </div>
                    <div class="text-center">
                        <p class="text-2xl font-bold text-purple-600" x-text="analytics?.last30Days?.uniqueVisitors || 0"></p>
                        <p class="text-sm text-gray-600">Unique Visitors (30 days)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div x-show="message" class="fixed top-4 right-4 max-w-sm">
            <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-4">
                <p x-text="message" :class="messageType === 'error' ? 'text-red-600' : 'text-green-600'"></p>
            </div>
        </div>
    </div>

    <script>
        function linkHubApp() {
            return {
                user: null,
                token: localStorage.getItem('token'),
                bioPage: null,
                themes: [],
                subscription: null,
                subscriptionPlans: [],
                analytics: null,
                message: '',
                messageType: 'success',
                
                loginForm: {
                    email: '',
                    password: ''
                },
                
                registerForm: {
                    email: '',
                    password: '',
                    username: ''
                },
                
                usernameForm: {
                    username: ''
                },
                
                linkForm: {
                    title: '',
                    url: ''
                },

                async init() {
                    if (this.token) {
                        await this.loadUser();
                    }
                    await this.loadThemes();
                    await this.loadSubscriptionPlans();
                },

                async apiCall(endpoint, options = {}) {
                    const url = `http://localhost:3000${endpoint}`;
                    const config = {
                        headers: {
                            'Content-Type': 'application/json',
                            ...(this.token && { 'Authorization': `Bearer ${this.token}` })
                        },
                        ...options
                    };

                    try {
                        const response = await fetch(url, config);
                        const data = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(data.error?.message || 'Request failed');
                        }
                        
                        return data;
                    } catch (error) {
                        this.showMessage(error.message, 'error');
                        throw error;
                    }
                },

                showMessage(text, type = 'success') {
                    this.message = text;
                    this.messageType = type;
                    setTimeout(() => {
                        this.message = '';
                    }, 5000);
                },

                async login() {
                    try {
                        const response = await this.apiCall('/api/auth/login', {
                            method: 'POST',
                            body: JSON.stringify(this.loginForm)
                        });
                        
                        this.token = response.data.token;
                        localStorage.setItem('token', this.token);
                        await this.loadUser();
                        this.showMessage('Login successful!');
                    } catch (error) {
                        // Error already shown by apiCall
                    }
                },

                async register() {
                    try {
                        const response = await this.apiCall('/api/auth/register', {
                            method: 'POST',
                            body: JSON.stringify(this.registerForm)
                        });
                        
                        this.token = response.data.token;
                        localStorage.setItem('token', this.token);
                        await this.loadUser();
                        this.showMessage('Registration successful!');
                    } catch (error) {
                        // Error already shown by apiCall
                    }
                },

                async loadUser() {
                    try {
                        const response = await this.apiCall('/api/user/profile');
                        this.user = response.data.user;
                        await this.loadBioPage();
                        await this.loadSubscription();
                        await this.loadAnalytics();
                    } catch (error) {
                        this.logout();
                    }
                },

                async claimUsername() {
                    try {
                        const response = await this.apiCall('/api/user/claim-username', {
                            method: 'POST',
                            body: JSON.stringify(this.usernameForm)
                        });
                        
                        this.user = response.data.user;
                        this.showMessage('Username claimed successfully!');
                    } catch (error) {
                        // Error already shown by apiCall
                    }
                },

                async loadBioPage() {
                    try {
                        const response = await this.apiCall('/api/bio-page');
                        this.bioPage = response.data.bioPage;
                    } catch (error) {
                        // Bio page might not exist yet
                    }
                },

                async loadThemes() {
                    try {
                        const response = await this.apiCall('/api/themes');
                        this.themes = response.data.themes;
                    } catch (error) {
                        // Error already shown by apiCall
                    }
                },

                async loadSubscription() {
                    try {
                        const response = await this.apiCall('/api/subscription/current');
                        this.subscription = response.data.subscription;
                    } catch (error) {
                        // Error already shown by apiCall
                    }
                },

                async loadSubscriptionPlans() {
                    try {
                        const response = await this.apiCall('/api/subscription/plans');
                        this.subscriptionPlans = response.data.plans;
                    } catch (error) {
                        // Error already shown by apiCall
                    }
                },

                async loadAnalytics() {
                    try {
                        const response = await this.apiCall('/api/analytics/summary');
                        this.analytics = response.data.summary;
                    } catch (error) {
                        // Error already shown by apiCall
                    }
                },

                async updateTheme(themeId) {
                    try {
                        const response = await this.apiCall('/api/bio-page', {
                            method: 'PUT',
                            body: JSON.stringify({ themeId })
                        });
                        
                        this.bioPage = response.data.bioPage;
                        this.showMessage('Theme updated successfully!');
                    } catch (error) {
                        // Error already shown by apiCall
                    }
                },

                async addLink() {
                    try {
                        const response = await this.apiCall('/api/bio-page/links', {
                            method: 'POST',
                            body: JSON.stringify(this.linkForm)
                        });
                        
                        this.bioPage = response.data.bioPage;
                        this.linkForm = { title: '', url: '' };
                        this.showMessage('Link added successfully!');
                    } catch (error) {
                        // Error already shown by apiCall
                    }
                },

                async deleteLink(linkId) {
                    if (!confirm('Are you sure you want to delete this link?')) return;
                    
                    try {
                        const response = await this.apiCall(`/api/bio-page/links/${linkId}`, {
                            method: 'DELETE'
                        });
                        
                        this.bioPage = response.data.bioPage;
                        this.showMessage('Link deleted successfully!');
                    } catch (error) {
                        // Error already shown by apiCall
                    }
                },

                async upgradeToPlan(plan) {
                    this.showMessage(`Stripe integration would redirect to checkout for ${plan.name}`, 'success');
                    // In a real app, this would create a Stripe checkout session
                },

                logout() {
                    this.user = null;
                    this.token = null;
                    this.bioPage = null;
                    this.subscription = null;
                    this.analytics = null;
                    localStorage.removeItem('token');
                    this.showMessage('Logged out successfully!');
                }
            }
        }
    </script>
</body>
</html>